---
title: Qt5.9.8 & vs2019 静态编译
date: 2019-08-24 15:09:24
tags:
---

## Qt5.9.8 & vs2019 静态编译

简单介绍Qt 5.9.8使用VS2019静态编译的过程以及可能遇到的问题的解决方法。首先是依赖，与运行不同，Qt在编译的时候会有一些其它依赖。请安装好它们并且添加至环境变量。

* Perl version 5.12 or later，[下载](http://strawberryperl.com)
选用的是strawberry perl，有Portable edition版可选。
* python3

除了上述依赖之外，Qt还有一些可选的外部库依赖，一些库在Qt源码中已经提供，我们只需要在配置的时候指定一下就好，一些并没有提供，需要自己下载别人编译好的或者需要自己编译。主要有两项，分别是ICU和OpenSSL。

### ICU

关于ICU在Qt中用于国际化的处理，如不想编译ICU也可跳过这一章节。编译ICU需要cygwin或者MSYS，采用MSYS没有编译成功，本文记录采用cygwin编译过程。

#### 源码下载

* [icu项目地址](http://site.icu-project.org)
* 安装[cygwin](http://www.cygwin.com/install.html)，至少安装以下几个工具:
  * make
  * dos2unix
  * binutils

#### 编译工程

* 打开命令行，设置环境变量，将 cygwin 的 bin 目录路经加入环境变量，执行命令 set PATH=%PATH%;D:\cygwin\bin
* 配置VC编译环境，执行命令 `call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"`
* 进入ICU根目录的 source 文件夹，转换文件，执行命令

    ```sh
    dos2unix *
    dos2unix -f configure

    ```

* 如果需要编成 MT 的，打开 runConfigureICU 文件，将 Cygwin/MSVC 配置中的 MD 改成 MT
* 配置编译选项，执行命令 `bash runConfigureICU Cygwin/MSVC -prefix=/cygdrive/z/icu --enable-static --disable-shared`
  * -prefix: 设置安装目录，注意，以 /cygdrive 开头
  * --enable-debug --disable-release：编Debug版本，什么都不加，默认为release
  * --enable-static --disable-shared：静态编译 lib
  * -–disable-static -–enable-shared：动态编译 dll

* 静态编译，执行命令 `make` ，注意用 cygwin 的 make
* 编译完成后，安装icu，执行命令 `make install` 命令执行完毕后，icu的库文件就会复制到之前 -prefix 参数指定的目录中
* 清理临时文件，`make.exe clean`
* 编译debug版，添加 --enable-debug --disable-release 选项无效，可修改runConfigureICU 中

    ```sh
    debug=0
    release=1
    ```

    为

    ```sh
    debug=1
    release=0
    ```

    单独编译出debug版。

### OpenSSL

Qt5.9.8 要求OpenSSL的版本是 >= 1.0.0 并且 < 1.1.0。编译OpenSSL需要 Perl。编译OpenSSL可添加添加zlib支持。

#### OpenSSL和zlib下载

* [openssl官网](https://www.openssl.org/source)
* zlib[下载](https://www.zlib.net)

#### zlib编译

* vs2019开发人员命令工具，选择 `x64 Native Tools Command Prompt for VS 2019`
* zlib源码根目录下进入到 contrib\masmx86 下 执行如下命令 `bld_ml64.bat`
* 启动 vs2019，打开 \contrib\vstudio\vc14\zlibvc.sln，升级工程
* 选择64位编译模式进行编译

#### 添加zlib支持

打开openssl\crypto\comp\c_zlib.c，在# include <zlib.h>上方添加#define ZLIB_WINAPI

#### 编译

* 打开命令行，设置perl环境 `call portableshell.bat /SETENV`
* 设置vs2019编译环境 `call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"`
* 设置OpenSSL编译选项 `call perl Configure VC-WIN64A no-asm no-shared --prefix=%openssl% zlib --with-zlib-include=d:\ops\zlib-1.2.11 --with-zlib-lib=d:\ops\zlib-1.2.11\x64\zlibstat.lib`
  * 输入下面两个命令之一配置编译选项，debug-VC-WIN32表示32位调试模式，VC-WIN64A表示64位模式，no-asm表示不用汇编，no-shared表示编译静态库，–prefix=表示最后生成的目录，zlib表示静态依赖zlib，–with-zlib-include=表示zlib的头文件目录，–with-zlib-lib=表示zlib的静态库文件路径
* cd openssl源码路径开始编译
  * 编译安装1.1.1c版

    ```bat
    nmake -f Makefile
    nmake -f Makefile install
    ```
  
  * 编译安装1.0.2s版
    * `call ms\do_win64a`
    * `nmake -f ms\nt.mak`
    * `nmake -f ms\nt.mak install`

### 编译Qt

[Qt 5.9.8源码下载](https://download.qt.io/archive/qt/5.9/5.9.8/single)，下载 qt-everywhere-opensource-src-5.9.8.zip。

* 打开命令行，设置perl环境 `call portableshell.bat /SETENV`
* 设置python环境，`set PATH=%PATH%;d:\ops\python3`
* 设置ICU环境变量
  
  ```bat
  set icu=d:\ops\icu
  set PATH=%PATH%;%icu%\bin
  set ICU_INCLUDE=%icu%\include
  set ICU_LIB=%icu%\lib
  ```

* 设置OpenSSL环境
  
  ```bat
  set OPENSSL=d:\ops\openssl-1.0.2s
  set PATH=%PATH%;%OPENSSL%\bin
  set OPENSSL_INCLUDE=%OPENSSL%\include
  set OPENSSL_LIB=%OPENSSL%\lib
  ```

* 进入Qt源码，创建 build 路径，并进入

  ```bat
  cd 5.9.8
  mkdir qt-build && cd qt-build
  ```

* 配置静态编译选项

  * 修改 qtbase\mkspecs\common\msvc-desktop.conf，再找到下面几行

    ``` conf
    QMAKE_CFLAGS_RELEASE = $$QMAKE_CFLAGS_OPTIMIZE -MD
    QMAKE_CFLAGS_RELEASE_WITH_DEBUGINFO += $$QMAKE_CFLAGS_OPTIMIZE -MD -Zi
    QMAKE_CFLAGS_DEBUG = -Zi -MDd
    ```

    修改成

    ``` conf
    QMAKE_CFLAGS_RELEASE = $$QMAKE_CFLAGS_OPTIMIZE -MT
    QMAKE_CFLAGS_RELEASE_WITH_DEBUGINFO += $$QMAKE_CFLAGS_OPTIMIZE -MT -Zi
    QMAKE_CFLAGS_DEBUG = -Zi -MTd
    ```

    就是把MD的编译选项改成MT。
  
  * 如果是vs2017及以上版本，修改 qtbase\mkspecs\common\msvc-version.conf，找下面几行

    ``` conf
    # https://developercommunity.visualstudio.com/content/problem/139261/msvc-incorrectly-defines-cplusplus.html
    # QMAKE_CXXFLAGS_CXX14 = -std:c++14
    # QMAKE_CXXFLAGS_CXX1Z = -std:c++latest
    ```

    修改成

    ``` conf
    # https://developercommunity.visualstudio.com/content/problem/139261/msvc-incorrectly-defines-cplusplus.html
    QMAKE_CXXFLAGS_CXX14 = -std:c++14
    QMAKE_CXXFLAGS_CXX1Z = -std:c++17
    ```

    另一处

    ``` conf
    greaterThan(QMAKE_MSC_VER, 1910) {
        # No compat spec past MSVC 2017
        COMPAT_MKSPEC       =
    }
    ```

    修改成

    ``` conf
    greaterThan(QMAKE_MSC_VER, 1910) {
        # No compat spec past MSVC 2017
        DEFINES += _ENABLE_EXTENDED_ALIGNED_STORAGE
        COMPAT_MKSPEC       =
    }
    ```

* 设置qt配置选项

    ```bat
    call ..\configure.bat -mp -release -static -static-runtime -confirm-license -platform win32-msvc -opensource -prefix %QT_INSTALL% -icu -I %ICU_INCLUDE% -L %ICU_LIB% ICU_LIBS="sicudt.lib sicuuc.lib sicuin.lib" -openssl -I %OPENSSL_INCLUDE% -L %OPENSSL_LIB% OPENSSL_LIBS="libeay32.lib ssleay32.lib" -opengl desktop -qt-zlib -nomake examples -nomake tests -skip qt3d -skip qtdatavis3d -skip qtgamepad -skip qtserialport -skip qtspeech -skip qtwayland -skip qtwebengine -skip qtwebview -skip qtremoteobjects
    ```

    具体配置详情如下：

    ```conf
    -confirm-license -opensource
    -release 版本
    -static 静态
    -platform win32-msvc 版本
    -static-runtime
    -mp 多线程编译
    -silent 不显示编译时多余的大量信息
    -opengl desktop 选择desktop而不是dynamic，避免qcustomplot无法使用opengl
    -qt-sqlite 三个选项[system/qt/no]选择源码自带
    -qt-pcre 三个选项[system/qt/no]选择源码自带
    -qt-zlib 三个选项[system/qt/no]选择源码自带
    -qt-freetype 三个选项[system/qt/no]选择源码自带
    -qt-harfbuzz 三个选项[system/qt/no]选择源码自带
    -qt-libpng 三个选项[system/qt/no]选择源码自带
    -qt-libjpeg 三个选项[system/qt/no]选择源码自带
    -nomake examples 不编译例子
    -nomake tests 不编译测试
    ```

    移除了 webengine、qtwebview等组件，qtremoteobjects配置出错，也移除了。

* 编译并安装

    ```bat
    nmake > z:\temp\nmake.out.txt 2>&1
    nmake install > z:\temp\nmake_install.out.txt 2>&1
    ```

    安装路径为上一步配置的 `-prefix` 路径。

## 参考

[Compiling-ICU-with-MSVC](https://wiki.qt.io/Compiling-ICU-with-MSVC)
